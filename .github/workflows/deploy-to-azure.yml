name: Deploy APIM + API Center

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Azure auth inputs
        shell: bash
        run: |
          CLIENT_ID="${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}"
          TENANT_ID="${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}"
          SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}"

          if [ -z "$CLIENT_ID" ] || [ -z "$TENANT_ID" ] || [ -z "$SUBSCRIPTION_ID" ]; then
            echo "Azure login inputs are missing. Set AZURE_CLIENT_ID, AZURE_TENANT_ID, and AZURE_SUBSCRIPTION_ID as repo secrets or repo variables."
            exit 1
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          client-id: ${{ secrets.AZURE_CLIENT_ID || vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID || vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID || vars.AZURE_SUBSCRIPTION_ID }}

      - name: Run Deployment Script
        shell: pwsh
        run: |
          ./scripts/deploy.ps1 `
            -SubscriptionId "86b37969-9445-49cf-b03f-d8866235171c" `
            -ResourceGroupName "ai-myaacoub" `
            -ApimServiceName "apim-poc-my" `
            -ApiCenterName "api-center-poc-my" `
            -AppServiceName "salespoc-api" `
            -ApiDisplayName "SalesPOC-API" `
            -ApiId "salespoc-api" `
            -ApiPath "salespoc-api" `
            -McpServerId "salespoc-api-mcp" `
            -ApiCenterEnvironmentId "production" `
            -ApiCenterIntegrationName "apim-poc-my-prod" `
            -ApiVersionId "v1" `
            -ApiDefinitionId "openapi" `
            -ApiDeploymentId "production" `
            -ApiAnalyzerConfigName "customrulesetpoc"
