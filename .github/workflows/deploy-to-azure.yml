name: Deploy APIM + API Center

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Azure auth inputs
        shell: bash
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          if [ -z "$AZURE_CREDENTIALS" ]; then
            echo "Azure login input is missing. Set AZURE_CREDENTIALS repository secret."
            exit 1
          fi

          echo "$AZURE_CREDENTIALS" | jq -e '.clientId and .clientSecret and .tenantId and .subscriptionId' > /dev/null || {
            echo "AZURE_CREDENTIALS is invalid. It must include clientId, clientSecret, tenantId, subscriptionId."
            exit 1
          }

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Deployment Script
        shell: pwsh
        run: |
          ./scripts/deploy.ps1 `
            -SubscriptionId "86b37969-9445-49cf-b03f-d8866235171c" `
            -ResourceGroupName "ai-myaacoub" `
            -ApimServiceName "apim-poc-my" `
            -ApiCenterName "api-center-poc-my" `
            -AppServiceName "salespoc-api" `
            -ApiDisplayName "SalesAPI" `
            -ApiId "salesApi" `
            -ApiPath "salesApi" `
            -McpServerId "sales-api-mcp" `
            -ApiCenterEnvironmentId "production" `
            -ApiCenterIntegrationName "apim-poc-my-prod" `
            -ApiVersionId "v1" `
            -ApiDefinitionId "openapi" `
            -ApiDeploymentId "production" `
            -ApiAnalyzerConfigName "customrulesetpoc"
